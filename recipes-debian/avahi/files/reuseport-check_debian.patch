From 16916078c6e45f6e74065e4af955b2a818d89481 Mon Sep 17 00:00:00 2001
From: Vu Tuan Anh <anh.vutuan@toshiba-tsdv.com>
Date: Mon, 19 Jan 2015 15:04:33 +0700
Subject: [PATCH] Fix avahi-daemon when running on kernel < 3.9 (patch taken
 from Ubuntu).

Upstream-Status: Pending (unmaintained upstream)
Signed-off-by: Ross Burton <ross.burton@intel.com>

Description: SO_REUSEPORT may not exist in running kernel
 When userspace defines SO_REUSEPORT we will attempt to enable socket
 port number reuse.  However if the running kernel does not support
 this call it will fail preventing daemon startup.  If this call is
 present but fails ENOPROTOOPT then we know that actually the kernel
 does not support it and we should continue as if we did not have the
 call at all.  (LP: #1228204)
 .
 This patch could be removed from the debian package after jessie release.
Author: Andy Whitcroft <apw@canonical.com>
---
 avahi-core/socket.c | 3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

diff --git a/avahi-core/socket.c b/avahi-core/socket.c
index 17ab6e5..5c76ca2 100644
--- a/avahi-core/socket.c
+++ b/avahi-core/socket.c
@@ -170,7 +170,8 @@ static int reuseaddr(int fd) {
     yes = 1;
     if (setsockopt(fd, SOL_SOCKET, SO_REUSEADDR, &yes, sizeof(yes)) < 0) {
         avahi_log_warn("SO_REUSEADDR failed: %s", strerror(errno));
-        return -1;
+        if (errno != ENOPROTOOPT)
+            return -1;
     }
 
 #ifdef SO_REUSEPORT
-- 
2.1.3

